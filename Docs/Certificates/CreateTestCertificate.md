# Создание тестового УКЭП КриптоПро

УКЭП — это Усиленная Квалифицированная Электронная подпись. Она представляет 
собой файл сертификата и связанный с ним приватный ключ. Приватным ключом можно 
подписать документ, а сертификатом можно проверить цифровую подпись. 
Обе операции требуют наличия установленного на вашем компьютере криптопровайдера. 
По умолчанию под Windows установлен криптопровайдер с алгоритмами RSA, 
а для работы с ИС Честный знак нам потребуется алгоритм ГОСТ, поэтому гостовский 
провайдер нужно установить вручную.

Алгоритмы ГОСТ поддерживаются несколькими провайдеров, самые распространенные 
из них — КриптоПро и Vipnet. В файле сертификата и в приватном ключе указывается 
не только название алгоритма по стандарту ГОСТ, но и конкретный криптопровайдер, 
который этот алгоритм реализует. Поэтому для Vipnet будут одни сертификаты, для 
КриптоПро — другие. В этой памятке описывается создание УКЭП с помощью сайта 
КриптоПро, так что и криптопровайдер потребуется тоже КриптоПро.

Для выпуска тестового сертификата УКЭП потребуется еще и плагин для браузера 
КриптоПро. Плагин нужен для взаимодействия браузера с установленным на вашей 
машине криптопровайдером, для установки приватного ключа в защищенное хранилище 
ключей на вашем компьютере и т.д.

### 1. Тестовый УКЭП можно выпустить на сайте КриптоПро

https://www.cryptopro.ru/ui/Register/RegGetSubject.asp

Плагин КриптоПро устанавливается в разные браузеры, но конкретно эта страница 
для выпуска электронной подписи, похоже, работает только в Internet Explorer, 
поскольку там используется VBScript. Ошибку скрипт сообщит не на первой странице, 
а когда-нибудь потом, когда попытается зарегистрировать сертификат, и текст 
ошибки будет невнятным, про Internet Explorer там упоминания не будет. 
Просто имейте в виду, что в других браузерах страница регистрации не работает. 

Заполнять поля совсем уж мусором нежелательно, потому что при регистрации 
пользователя в ИС Честный знак потребуется соответствие полей Имя, Фамилия, 
Отчество и ИНН:

![Пример заполнения полей](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/01-PushkinCertificate.png?raw=true)

### 2. УКЭП выпускается в два этапа.

Заполняются поля, на следующей странице копируется маркер временного доступа и пароль:

![Маркер временного доступа](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/02-PushkinCertificate.png?raw=true)

### 3. Запрос на генерацию ключа

Если на этом этапе страница падает — значит, вы, вероятно проигнорировали 
требование использовать Internet Explorer. Страница обращается к плагину КриптоПро 
и запрашивает разрешение на выполнение операции плагина. Плагин должен выяснить, 
какие алгоритмы доступны на текущих установленных на вашей машине криптопровайдерах. 
Разрешение надо дать:

![Запрос сертификата](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/04-PushkinCertificate.png?raw=true)

### 4. Параметры УКЭП: алгоритм, разрядность

Для работы с тестовым стендом годится любой ключ и любой ГОСТ-овский алгоритм. 
Выбираете, нажимаете `Отправить`:

![Параметры](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/06-PushkinCertificate.png?raw=true)

### 5. Выбор хранилища для ключа

Плагин запросит, в какое хранилище поместить сгенерированный ключ. Ключ — вещь 
ответственная, поэтому он будет лежать в хранилище, защищенном с помощью пароля. 
Я рекомендую выбирать для верности реестр, оттуда ключ всегда можно будет экспортировать:

![Хранилище ключа](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/07-PushkinCertificate.png?raw=true)

### 6. Генерация ключа

Ключ представляет собой 512- или 1024-битное случайное число. Для его генерации 
не подойдет обычный генератор случайных чисел, поэтому при генерации ключа нужен 
дополнительный источник энтропии. Плагин КриптоПро попросит вас повозить и 
покликать по экрану мышкой, чтобы добавить эту случайную информацию во время 
генерации ключа:

![Генерация ключа](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/08-PushkinCertificate.png?raw=true)

### 7. Создание пароля

Ключ готов. Теперь этот ключ устанавливается в хранилище, которое будет защищено 
паролем. Требований к сложности пароля нет, для тестового УКЭП допустимо использовать 
простой пароль:

![Генерация ключа](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/09-PushkinCertificate.png?raw=true)

### 8. Установка сертификата в хранилище

Плагин снова запрашивает разрешение, теперь на установку сертификата. К сожалению, 
в окошке нет указаний, какой именно сертификат устанавливается. Видимо, имеется 
в виду только что созданный сертификат. Разрешаем:

![Установка сертификата](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/10-PushkinCertificate.png?raw=true)

### 9. Сертификат можно скачать

Добрались до страницы, на которой есть ссылки для скачивания и установки сертификата. 
Воспользуйтесь ссылкой Сохранить сертификат в файле, в нижней части страницы. 
Сертификат понадобится для регистрации пользователя на тестовом стенде Честного знака:

![Скачивание сертификата](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/11-PushkinCertificate.png?raw=true)

### 10. VBScript спросит, куда сохранять

Кнопки Browse нет :)

![Скачивание сертификата](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/12-PushkinCertificate.png?raw=true)

### 11. Еще один запрос от Internet Explorer

По-видимому, скрипт пытается сохранить сертификат в файл с помощью какого-то 
ActiveX-объекта. В данном случае это безопасно:

![Скачивание сертификата](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/13-PushkinCertificate.png?raw=true)

### 12. Попытка установки сертификата

На этой странице есть еще одна отдельная кнопка `Установка сертификата`. Не знаю, 
куда эта кнопка предполагает установить сертификат, если в личное хранилище плагин 
этот сертификат вроде бы уже установил на прошлом шаге. В любом случае, эта функция 
не работает, пока в списке доверенных сертификатов не установлен сертификат 
Тестового УЦ ООО "КРИПТО-ПРО". Чтобы подписывать своим тестовым УКЭП документы, 
этот сертификат в любом случае придется установить в доверенные:

![Неудачная установка](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/16-PushkinCertificate.png?raw=true)

### 13. Установка сертификата

Установить сертификат в личное хранилище или в хранилище компьютера можно из файла. 
В контекстном меню есть пункт Install certificate:

![Удачная установка](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/18-PushkinCertificate.png?raw=true)

### 14. Выбор хранилища

Мастер установки сертификата позволяет установить сертификат в хранилище текущего 
пользователя (личное) или хранилище компьютера. Второй вариант доступен только 
администраторам. Я выбрал первый вариант, личное хранилище:

![Выбор хранилища](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/19-PushkinCertificate.png?raw=true)

### 15. Личные хранилища тоже бывают разные

Мастер предлагает автоматом подобрать подходящее хранилище для сертификата, либо 
указать свое. Пускай подберет сам:

![Выбор хранилища](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/20-PushkinCertificate.png?raw=true)

### 16. При установке потребуется пароль

Введите пароль, который вы придумали на шаге 7. Можно поставить галочку Save 
password in system, чтобы плагин не запрашивал снова этот пароль при каждой 
операции вычисления цифровой подписи:

![Установка](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/23-PushkinCertificate.png?raw=true)

### 17. Импорт в личное хранилище завершен

![Импорт завершен](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/24-PushkinCertificate.png?raw=true)

### 18. Экспорт сертификата

Сертификат можно перенести из одного хранилища в другое. Например, для установки 
на другом компьютере. Или для переноса из личного хранилища в хранилище компьютера. 
Для переноса сертификат вместе с ключом нужно экспортировать. Это делается с помощью 
MMC-оснастки `CryptoPro CSP`, которая доступна в Панели управления, в разделе 
Система и безопасность:

![Импорт завершен](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/25-PushkinCertificate.png?raw=true)

### 19. Экспорт с ключом или без ключа

Если экспортировать без ключа — будет выгружен один только сертификат. Им можно 
только проверить цифровую подпись, но нельзя подписать документ. Нам нужен экспорт 
с ключом:

![Экспорт с ключом](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/27-PushkinCertificate.png?raw=true)

### 20. Настройки экспорта

Оставляем по умолчанию. Для импорта под Windows подойдет любой формат, для которого 
есть экспорт. С галкой `Delete the private key` рекомендую обращаться осторожно, 
хорошо подумать, прежде чем удалять ключ из хранилища или оставлять его там:

![Формат экспорта](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/28-PushkinCertificate.png?raw=true)

### 21. Пароль

Файл для временного хранения ключа должен быть запаролен. Требований к сложности 
пароля, правда, нет:

![Формат экспорта](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/29-PushkinCertificate.png?raw=true)

### 22. Файл для экспорта

Далее нужно выбрать имя файла для экспорта, на этом все:

![Файл для экспорта](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/30-PushkinCertificate.png?raw=true)

### 23. Импорт сертификата с ключом

Экспортированный файл можно импортировать той же остнасткой `CryptoPro CSP`. Выбираете 
нужное хранилище и в контекстном меню операцию All tasks -> Import:

![Импорт](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/33-PushkinCertificate.png?raw=true)

### 24. Пароль от PFX

При импорте потребуется пароль от PFX-файла, созданный на шаге 21. Такой пароль, 
как на скриншоте, можно использовать только для мусорных тестовых сертификатов:

![Пароль от файла](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/36-PushkinCertificate.png?raw=true)

### 25. Выбор хранилища

Дальше снова следует запрос типа и расположения хранилища:

![Тип хранилища](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/39-PushkinCertificate.png?raw=true)

### 26. Пароль от хранилища

Тут нужно придумать новый пароль, под которым ключ будет защищен уже в постоянном 
хранилище:

![Пароль от хранилища](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/40-PushkinCertificate.png?raw=true)

### 27. Проверьте установленный сертификат

После импорта сертификата с ключом можно проверить его свойства в хранилище. 
Убедитесь, что на иконке сертификата показан ключик, а в свойствах сертификата 
написано: You have a private key that corresponds to this certificate. A certificate 
that has a corresponding private key is also known as a digital ID:

![Пароль от хранилища](https://github.com/yallie/MdlpClient/blob/master/Docs/Certificates/screenshots/43-PushkinCertificate.png?raw=true)
